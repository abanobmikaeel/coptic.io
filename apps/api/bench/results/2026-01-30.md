# Coptic.IO Performance Benchmarks - 2026-01-30

## Summary

Major performance optimization in three phases:
1. Cached `Intl.DateTimeFormat` objects (55x iCal speedup)
2. O(1) celebration lookups via Map
3. **Pure arithmetic Coptic date conversion** - replaced Intl entirely (additional 50x speedup)

## Final Results

### Throughput (Requests/Second)
  - Health: 12,156 req/s
  - Celebrations: 11,308 req/s
  - Fasting: 10,423 req/s
  - Readings: 5,096 req/s

### Latency (Single Request)
  - Fasting: 0.8ms
  - Health: 1.3ms
  - Celebrations: 3.6ms
  - GraphQL: 6.5ms
  - Readings: 8.8ms

## Comparison to Original (2025-11-22)

| Endpoint | Original | Final | Improvement |
|----------|----------|-------|-------------|
| **Throughput (req/s)** |
| Health | 4,387 | 12,156 | **2.8x** |
| Celebrations | 2,652 | 11,308 | **4.3x** |
| Fasting | 3,376 | 10,423 | **3.1x** |
| Readings | 1,675 | 5,096 | **3.0x** |
| **Latency** |
| Celebrations | 16.7ms | 3.6ms | **4.6x faster** |
| Fasting | 2.3ms | 0.8ms | **2.9x** |
| GraphQL | 12.6ms | 6.5ms | **1.9x** |

## What Changed

### 1. Pure arithmetic Coptic date conversion (`copticDate.ts`)
Replaced `Intl.DateTimeFormat` with algorithm ported from ICU cecal.cpp:
```typescript
// Before: 5 Intl.DateTimeFormat.format() calls per date
// After: Pure integer arithmetic - Julian Day Number conversion
function jdToCoptic(jd: number) {
  const jday = jd - 1824665  // Coptic epoch offset
  const c4 = Math.floor(jday / 1461)  // 4-year cycles
  const r4 = jday - c4 * 1461
  const year = 4 * c4 + Math.floor(r4 / 365) - Math.floor(r4 / 1460)
  // ...
}
```
- **Impact: 50x faster per date conversion**

### 2. Celebration lookup optimization (`getStaticCelebrations.ts`)
- Before: `Array.find()` O(n) scan per lookup
- After: `Map.get()` O(1) hash lookup

### 3. String concatenation fix (`icalGenerator.ts`)
- Before: `ical += ...` O(nÂ²) string copies
- After: `lines.push()` + `join()` O(n)

## iCal Generation Performance

| Metric | Original | Cached Intl | Pure Math | Total Speedup |
|--------|----------|-------------|-----------|---------------|
| Single year | ~103ms | 1.9ms | **0.64ms** | **161x** |
| Multi-year (4yr) | ~320ms | 10ms | **1.97ms** | **162x** |

## Source
Coptic calendar algorithm from ICU (International Components for Unicode):
https://github.com/unicode-org/icu/blob/main/icu4c/source/i18n/cecal.cpp
