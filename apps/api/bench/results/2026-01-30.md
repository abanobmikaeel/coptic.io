# Coptic.IO Performance Benchmarks - 2026-01-30

## Summary

Major performance optimization in four phases:
1. Cached `Intl.DateTimeFormat` objects (55x iCal speedup)
2. O(1) celebration lookups via Map
3. **Pure arithmetic Coptic date conversion** - replaced Intl entirely (50x speedup)
4. **Consolidated to @coptic/core** - all packages now use optimized conversion

## Final Results

### Throughput (Requests/Second)
  - Fasting: 11,704 req/s
  - Readings: 10,838 req/s
  - Celebrations: 9,475 req/s
  - Health: 7,343 req/s

### Latency (Single Request)
  - Readings: 1.2ms
  - Fasting: 1.9ms
  - Celebrations: 5.4ms
  - GraphQL: 7.7ms

## Comparison to Original (2025-11-22)

| Endpoint | Original | Final | Improvement |
|----------|----------|-------|-------------|
| **Throughput (req/s)** |
| Readings | 1,675 | 10,838 | **6.5x** |
| Fasting | 3,376 | 11,704 | **3.5x** |
| Celebrations | 2,652 | 9,475 | **3.6x** |
| Health | 4,387 | 7,343 | **1.7x** |
| **Latency** |
| Readings | 2.5ms | 1.2ms | **2.1x faster** |
| Fasting | 2.3ms | 1.9ms | **1.2x** |
| Celebrations | 16.7ms | 5.4ms | **3.1x** |
| GraphQL | 12.6ms | 7.7ms | **1.6x** |

## What Changed

### 1. Pure arithmetic Coptic date conversion (`@coptic/core`)
Replaced `Intl.DateTimeFormat` with algorithm ported from ICU cecal.cpp:
```typescript
// Before: 5 Intl.DateTimeFormat.format() calls per date
// After: Pure integer arithmetic - Julian Day Number conversion
function jdToCoptic(jd: number) {
  const jday = jd - 1824665  // Coptic epoch offset
  const c4 = Math.floor(jday / 1461)  // 4-year cycles
  const r4 = jday - c4 * 1461
  const year = 4 * c4 + Math.floor(r4 / 365) - Math.floor(r4 / 1460)
  // ...
}
```
- **Impact: 50x faster per date conversion**

### 2. Consolidated to @coptic/core
- Deleted duplicate `apps/api/src/utils/copticDate.ts`
- All packages now import `gregorianToCoptic` from `@coptic/core`
- **Impact: Readings endpoint jumped from 5,096 to 10,838 req/s (2.1x)**

### 3. Celebration lookup optimization (`getStaticCelebrations.ts`)
- Before: `Array.find()` O(n) scan per lookup
- After: `Map.get()` O(1) hash lookup

### 4. String concatenation fix (`icalGenerator.ts`)
- Before: `ical += ...` O(nÂ²) string copies
- After: `lines.push()` + `join()` O(n)

## iCal Generation Performance

| Metric | Original | Cached Intl | Pure Math | Total Speedup |
|--------|----------|-------------|-----------|---------------|
| Single year | ~103ms | 1.9ms | **0.71ms** | **145x** |
| Multi-year (4yr) | ~320ms | 10ms | **3.04ms** | **105x** |

## Source
Coptic calendar algorithm from ICU (International Components for Unicode):
https://github.com/unicode-org/icu/blob/main/icu4c/source/i18n/cecal.cpp
